# AnsiblePlaybooks для развертывания контейнерных приложений в Kubernetes

Репозиторий содержит AnsiblePlaybooks для генерации артефактов развертывания приложений в Kubernetes (deployment, services, secrets), скриптов загрузки файлов конфигурации в Kubernetes, а также применение, созданных артефактов развертывания в Kubernetes.

> **Примечение:** Скрипты загрузки конфигурационных файлов применяются вручную.

---

## Оглавление

1. [Требования к контейнерам](#container_requirements)
2. [Подготовка к развертыванию приложений](#preparation)
3. [Генерация артефактов развертывания](#create_deployments)
4. [Развёртывани приложений](#apply_deployments)

## <a name="container_requirements">Требования к контейнерам</a>

1. Контейнер должен содержать только одно запускаемое приложение. Если приложение состоит из нескольких компонентов, то каждый компонент должен запускаться в своём контейнере. Например, для Nginx+php-fpm должны быть два контейнера – c nginx и php-fpm и т. п.
2. Приложение в контейнере должно писать логи в stdout/stderr (/proc/self/fd/2). [Пример для php-fpm](https://pracucci.com/php-on-kubernetes-application-logging-via-unix-pipe.html)
3. Контейнеры, работающие в одном pod используют один тот же IP-адрес и пространство портов, поэтому такие приложения должны это учитывать (например, работать на разных портах и т.п.).
4. Контейнеры должны включать всё необходимое для своей работы (специфичные настройки приложений, средонезависимые параметры запуска приложения, шаблоны документов, переменные окружения т. п.). Средозависимые параметры (адреса серверов и параметры подключения к ним, сертификаты и т. п.) выносятся в артефакты Kubernetes такие как ConfigMap и Secrest.

## <a name="preparation">Подготовка к развертыванию приложений</a>

TBD;

### Конфигурационные параметры приложений

TBD;

## <a name="#create_deployments">Генерация артефактов развертывания</a>

Для создания структуры каталогов и артефактов, необходимых для развертывания приложений в Kubernetes, выполнить playbook:

```bash
cd k8s-deploy-tethus-ansible
ansible-playbook -i inventory/tethus.ini playbooks/create_deployments.yml
```

На указанном в `.ini`-файле мастере Kubernetes в каталоге `/opt` создаётся структура каталогов приложения `[namespace]/[application_name]/[contaiten_name]/{certs,configs,template_files}`.

### Описание созданной структуры каталогов

TBD;

## <a name="apply_deployments">Развёртывани приложений</a>

Для установки созданных на предыдущем шаге артефактов Kubernetes, выполнить playbook:

```bash
cd k8s-deploy-tethus-ansible
ansible-playbook -i inventory/tethus.ini playbooks/apply_deployments.yml
```
